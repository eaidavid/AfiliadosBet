ğŸ§¾ CONTEXTO DO SISTEMA
VocÃª estÃ¡ desenvolvendo um sistema de afiliados chamado AfiliadosBet, que jÃ¡ possui:

Backend com banco de dados estruturado em PostgreSQL.

Tabela de betting_houses onde Ã© possÃ­vel configurar cada casa de apostas, incluindo:

Tipo de comissÃ£o: revshare ou cpa

Percentual total da comissÃ£o enviado pela casa (revshare_value ou cpa_value)

Percentual que serÃ¡ repassado ao afiliado (revshare_affiliate_percent ou cpa_affiliate_percent)

Recebimento de dados via postback das casas, jÃ¡ com os valores brutos calculados (ex: R$350 enviados = 35% da receita de R$1000).

Registro das conversÃµes em conversions, onde ficam amount, commission, conversion_data, etc.

VocÃª Ã© o afiliado master (admin), e deseja repassar parte da comissÃ£o para seus afiliados.

ğŸ¯ OBJETIVO
Implementar no backend e refletir no painel administrativo a lÃ³gica correta de cÃ¡lculo e divisÃ£o de comissÃµes entre:

O afiliado final (usuÃ¡rio que gerou o lead/conversÃ£o)

O afiliado master (vocÃª), que recebe a comissÃ£o total da casa e repassa parte

A lÃ³gica deve funcionar para os dois tipos de comissÃ£o:

ğŸ”¹ RevShare
Valor recebido no postback = percentual da receita enviado pela casa (ex: 35% da receita).

O afiliado ganha uma fraÃ§Ã£o desse valor, proporcional ao percentual repassado.

O restante fica com o master.

ğŸ”¹ CPA
Valor fixo enviado no postback (ex: R$500).

O afiliado ganha uma porcentagem desse valor (ex: 70%), e o restante fica com o master.

ğŸ”£ LÃ“GICA DE CÃLCULO
âœ… FÃ³rmulas Universais:

plaintext
Copiar
Editar
# Para ambos os tipos:
comissao_do_afiliado = valor_postback Ã— (percentual_repassado / percentual_total)
comissao_do_master   = valor_postback Ã— ((percentual_total - percentual_repassado) / percentual_total)
ğŸ§® EXEMPLOS PRÃTICOS
Exemplo 1 â€” RevShare
Casa: Bet365

Receita: R$1000

Percentual total enviado pela casa: 35%

Valor recebido no postback: R$350

Percentual repassado ao afiliado: 20%

ini
Copiar
Editar
comissao_afiliado = 350 Ã— (20 / 35) = R$200
comissao_master = 350 - 200 = R$150
Exemplo 2 â€” CPA
Casa: Blaze

Valor CPA por jogador: R$500

Valor recebido no postback: R$500

Percentual repassado ao afiliado: 70%

ini
Copiar
Editar
comissao_afiliado = 500 Ã— (70 / 100) = R$350
comissao_master = 500 - 350 = R$150
ğŸ—„ï¸ INTEGRAÃ‡ÃƒO NO BACKEND
Quando um postback for recebido:

Registrar o valor_postback como amount na tabela conversions.

Obter da tabela betting_houses:

commission_type

revshare_value ou cpa_value

revshare_affiliate_percent ou cpa_affiliate_percent

Aplicar a fÃ³rmula correta com base no tipo de comissÃ£o.

Armazenar:

Em commission: apenas o valor destinado ao afiliado.

Em conversion_data: JSON com detalhes como:

json
Copiar
Editar
{
  "tipo_comissao": "revshare",
  "valor_total_postback": 350,
  "percentual_total": 35,
  "percentual_repassado": 20,
  "valor_afiliado": 200,
  "valor_master": 150
}
NÃ£o sobrescrever valores retroativos ao atualizar percentuais. Os cÃ¡lculos devem ser feitos com base nos percentuais em vigor no momento do evento.

ğŸ’» INTERFACE DO PAINEL ADMINISTRATIVO
A tela de criaÃ§Ã£o/ediÃ§Ã£o de casas de apostas deve permitir configurar:

Campo	Tipo	DescriÃ§Ã£o
Tipo de comissÃ£o	Select	revshare ou cpa
Percentual total (revshare)	Input %	Percentual da receita pago pela casa (ex: 35%)
Percentual repassado ao afiliado (revshare)	Input %	Quanto do total serÃ¡ repassado ao afiliado (ex: 20%)
Valor fixo CPA	Input R$	Valor total enviado no postback (ex: R$500)
Percentual CPA para afiliado	Input %	Quanto do valor CPA vai para o afiliado (ex: 70%)

Esses valores devem ser salvos nos campos correspondentes da tabela betting_houses.

ğŸ” SEGURANÃ‡A E ESCALABILIDADE
Os valores devem ser validados no backend, inclusive para evitar divisÃµes por zero.

O painel deve permitir alterar os percentuais sem afetar comissÃµes jÃ¡ registradas.

O sistema precisa ser preparado para lidar com mÃºltiplas casas com regras diferentes.

A lÃ³gica de cÃ¡lculo deve ser centralizada para facilitar manutenÃ§Ã£o e testes.

ğŸ“Œ RECOMENDAÃ‡Ã•ES FINAIS
Armazene os cÃ¡lculos detalhados no conversion_data para rastreabilidade.

Use o user_id e house_id para garantir que cada comissÃ£o seja corretamente associada.

Mantenha logs de postbacks recebidos na tabela postback_logs para auditoria.

Permita a visualizaÃ§Ã£o do valor total recebido e a divisÃ£o no painel do afiliado e do admin.

