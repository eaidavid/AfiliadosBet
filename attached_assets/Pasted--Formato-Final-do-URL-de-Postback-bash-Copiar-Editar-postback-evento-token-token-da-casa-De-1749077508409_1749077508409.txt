âœ… Formato Final do URL de Postback
bash
Copiar
Editar
/postback/{evento}?token={token_da_casa}
ğŸ” Detalhamento de Cada Parte
ğŸ”¹ /postback/
DescriÃ§Ã£o: Prefixo fixo da rota que identifica que se trata de uma requisiÃ§Ã£o de postback no sistema.

Responsabilidade: Direciona para o controller responsÃ¡vel por interpretar e registrar o evento vindo da casa de apostas.

ObservaÃ§Ã£o: Essa rota deve estar protegida contra ataques (rate limit, IP allowlist ou token validation).

ğŸ”¹ {evento}
DescriÃ§Ã£o: Representa o tipo de evento sendo reportado pela casa de apostas.

Valores possÃ­veis:

click â†’ clique no link de afiliado

register â†’ novo cadastro do usuÃ¡rio na casa de apostas

deposit â†’ primeiro ou novo depÃ³sito feito

revenue â†’ comissÃ£o baseada em receita (RevShare)

Uso interno: Esse valor define qual serÃ¡ o tipo registrado na tabela conversions.type, e possivelmente determina o cÃ¡lculo da comissÃ£o.

ValidaÃ§Ã£o: Deve aceitar apenas os eventos permitidos. Caso contrÃ¡rio, deve retornar erro 400 ou 422.

ğŸ”¹ ?token={token_da_casa}
DescriÃ§Ã£o: Token Ãºnico e exclusivo da casa de apostas. Serve como identificador seguro e inalterÃ¡vel.

Origem: Este token Ã© gerado automaticamente ao criar uma casa, armazenado no campo betting_houses.security_token.

Uso interno:

Localiza a casa de apostas relacionada ao evento.

Valida se o postback Ã© legÃ­timo (inclusive pode usar para autorizar).

Usado para consultar a configuraÃ§Ã£o de postbacks da casa (parÃ¢metros esperados, permissÃµes, etc).

ImportÃ¢ncia: O token substitui a necessidade de enviar house_id via GET e evita exposiÃ§Ã£o de dados sensÃ­veis.

ğŸ§ª Exemplos de URLs Reais
Para uma casa com token abc123securetoken456:

Tipo de Evento	URL
Click	/postback/click?token=abc123securetoken456
Registro	/postback/register?token=abc123securetoken456
DepÃ³sito	/postback/deposit?token=abc123securetoken456
Receita	/postback/revenue?token=abc123securetoken456

ğŸ›¡ï¸ ValidaÃ§Ãµes Recomendadas no Backend
Verificar se o token existe e corresponde a uma casa ativa (betting_houses.is_active = true)

Verificar se o evento (click, register, etc) estÃ¡ habilitado para essa casa (enabled_postbacks inclui o evento)

Logar todos os dados recebidos (no mÃ­nimo token, evento, IP e query string) na tabela postback_logs

Se o subid (parÃ¢metro de referÃªncia de afiliado) estiver presente, associar ao affiliate_links e users